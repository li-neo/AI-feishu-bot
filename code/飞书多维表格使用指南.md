# 飞书多维表格使用指南

## 1. 什么是飞书多维表格

飞书多维表格是飞书提供的一种强大的数据管理工具，它结合了表格、看板、甘特图等多种视图，可以灵活地组织和管理数据。我们可以使用飞书多维表格来管理周报内容，实现周报的自动化生成和发送。

## 2. 如何创建飞书多维表格

### 2.1 步骤1：创建多维表格

1. 打开飞书客户端
2. 点击左侧导航栏中的「多维表格」
3. 点击右上角的「创建」按钮
4. 选择「从空白表格创建」
5. 给表格起一个名称，例如「AI周报内容管理」

### 2.2 步骤2：设计表格结构

飞书多维表格需要按照以下列结构设计，系统会自动识别这些列并生成相应的周报内容：

| 列名 | 类型 | 描述 |
|------|------|------|
| 名称 | 文本 | 周报条目的标题，支持Markdown格式 |
| 描述 | 文本 | 周报条目的详细描述，支持Markdown格式和换行 |
| 图片key1 | 文本 | 第一张图片的key（可选） |
| 图片key2 | 文本 | 第二张图片的key（可选） |
| URL | 文本 | 相关链接（可选） |

**注意事项**：
- 列名必须严格按照上述名称设置，否则系统无法识别
- 支持的图片key格式：`img_v3_xxx_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxg`
- 支持Markdown格式，例如：`**加粗**`、`*斜体*`、`[链接](url)`等
- 支持换行，直接在单元格中按Enter键即可

### 2.3 步骤3：添加示例数据

在表格中添加一些示例数据，例如：

| 名称 | 描述 | 图片key1 | 图片key2 | URL |
|------|------|----------|----------|-----|
| **<font color='blue'>【图像生成】新模型发布</font>** | - ⬆️输入：图片、文字<br>- 🖥️输出：视频<br>- ✨亮点：支持1080p视频生成 | img_v3_02qj_f1536d71-ebb9-429b-8efb-39f2fcfc73cg | img_v3_02qj_69d8191e-a087-4f77-a269-e1d1fe61406g | https://bytedance.larkoffice.com/docx/ONGcdldR1oG7ggxjYEyc75zrn0f |

## 3. 如何获取多维表格的配置信息

### 3.1 获取BITABLE_TOKEN和TABLE_ID

使用飞书多维表格链接获取配置信息，链接格式为：`https://bytedance.larkoffice.com/base/BITABLE_TOKEN?table=TABLE_ID&view=VIEW_ID`

#### 3.1.1 获取BITABLE_TOKEN
BITABLE_TOKEN是飞书多维表格的唯一标识符，也称为app_token。获取方法：
1. 打开飞书多维表格
2. 点击右上角的「分享」按钮，点击「获取链接」
3. 或者直接从浏览器地址栏复制链接
4. 从链接中提取`base/`后面、`?`前面的字符串
5. 例如：链接为`https://bytedance.larkoffice.com/base/VJxQb9CvsaC3dJsMWGNcY5Ctneq?table=tbllDjGyEJXPdtJI&view=vewuHiEcQB`，则BITABLE_TOKEN为`VJxQb9CvsaC3dJsMWGNcY5Ctneq`

#### 3.1.2 获取TABLE_ID
TABLE_ID是多维表格中具体表的标识符。获取方法：
- **方法1（推荐）**：从浏览器地址栏链接中提取`table=`后面、`&`前面的字符串
  - 例如：链接为`https://bytedance.larkoffice.com/base/VJxQb9CvsaC3dJsMWGNcY5Ctneq?table=tbllDjGyEJXPdtJI&view=vewuHiEcQB`，则TABLE_ID为`tbllDjGyEJXPdtJI`
- **方法2**：从多维表格设置中获取
  1. 打开飞书多维表格
  2. 点击左下角的「设置」按钮（齿轮图标）
  3. 选择「高级」选项
  4. 在「表ID」字段中找到TABLE_ID

**注意**：如果无法通过上述方式获取TABLE_ID，可以通过飞书开放平台的调试工具获取。

### 3.2 飞书应用权限配置

#### 3.2.1 权限需求
使用飞书多维表格功能需要为飞书应用配置以下权限（至少选择一个）：
- `bitable:app:readonly` - 多维表格只读权限
- `bitable:app` - 多维表格读写权限
- `base:record:retrieve` - 记录查询权限

#### 3.2.2 配置权限步骤
1. 打开飞书开放平台控制台：https://open.feishu.cn/app/cli_a9afe48337fb5bde/auth
2. 在"权限管理"页面找到上述权限
3. 点击"申请权限"按钮
4. 根据提示完成权限申请和配置
5. 确保权限状态为"已启用"

## 4. 如何配置card.py文件

### 4.1 打开card.py文件

使用文本编辑器打开`/Users/bytedance/AI/csm_ai/code/card.py`文件。

### 4.2 配置多维表格信息

找到以下配置项，填入您的多维表格信息（示例值）：

```python
# 3. 使用飞书多维表格（推荐，功能更强大）
BITABLE_TOKEN = "VJxQb9CvsaC3dJsMWGNcY5Ctneq"  # 替换为你的多维表格token
TABLE_ID = "tbllDjGyEJXPdtJI"  # 替换为你的多维表格中的表ID
```

### 4.3 启用动态数据获取

将`ENABLE_DYNAMIC_DATA`设置为`True`，启用从多维表格获取数据：

```python
# 是否启用动态数据获取（True: 从飞书文档/表格/多维表格获取，False: 使用静态数据）
ENABLE_DYNAMIC_DATA = True
```

### 4.4 保存配置

保存card.py文件。

## 5. 如何测试和运行

### 5.1 测试多维表格功能

运行以下命令测试多维表格功能：

```bash
python test_bitable.py
```

### 5.2 生成并发送周报

运行以下命令生成并发送周报：

```bash
python weekly_report.py
```

### 5.3 测试发送功能

运行以下命令测试发送功能（发送到测试群组）：

```bash
python test_weekly_report.py
```

### 5.4 增强的错误处理

我们已经增强了错误处理机制，当出现权限问题时，会显示详细的错误信息和解决方案。例如：

```
ERROR: Failed to fetch bitable content: Permission denied. Error code: 99991672
Please enable the required permissions for your Feishu app at:
https://open.feishu.cn/app/cli_a9afe48337fb5bde/auth?q=bitable:app:readonly,bitable:app,base:record:retrieve
Error details: Access denied. One of the following scopes is required: [bitable:app:readonly, bitable:app, base:record:retrieve]
```

## 6. 常见问题

### 6.1 如何获取图片key？

1. 打开飞书素材库或上传图片到飞书文档/群聊
2. 上传或选择一张图片
3. 右键点击图片，选择「复制图片链接」，或在素材库右侧信息栏中找到"图片key"
4. 链接格式为：`https://bytedance.larkoffice.com/xxxxxx/xxxxxx/xxxxxx/img_v3_xxx_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxg`
5. 其中的`img_v3_xxx_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxg`就是图片key

### 6.2 如何修改周报标题？

当前版本的周报标题默认为"本周AI动态速览"，如需修改，可在`doc_fetcher.py`文件中修改`get_weekly_report_data`函数中的`common`变量。

### 6.3 如何添加更多列？

如果需要扩展更多列，需要修改`doc_fetcher.py`文件中的`parse_sheet_data`函数，添加对新列的解析逻辑。

### 6.4 为什么动态数据获取失败？

- 检查`card.py`中的配置是否正确（BITABLE_TOKEN和TABLE_ID）
- 检查飞书应用是否有访问多维表格的权限（参考第3.2节）
- 检查网络连接是否正常
- 查看控制台输出的错误信息，根据提示进行修复

### 6.5 系统容错机制

当动态数据获取失败时，系统会自动回退到使用静态数据，确保周报能够正常发送。

### 6.6 如何处理权限问题？

如果运行脚本时遇到权限错误，按以下步骤操作：
1. 确保飞书应用已配置所需权限（参考第3.2节）
2. 检查权限状态是否为"已启用"
3. 查看控制台输出的详细错误信息，根据提示进行修复

## 7. 最佳实践

1. **定期备份数据**：建议定期导出多维表格数据，以防数据丢失
2. **统一数据格式**：确保团队成员按照统一格式填写数据，便于解析
3. **使用模板**：创建一个多维表格模板，每次周报应使用该模板
4. **测试后再发送**：每次修改配置后，先运行`test_weekly_report.py`测试，确保无误后再发送正式周报
5. **及时更新权限**：如果飞书应用权限到期，及时更新权限配置
6. **关注错误信息**：系统会显示详细的错误信息，根据提示进行修复即可
7. **定期更新数据**：每周定期更新多维表格中的数据
8. **合理设置权限**：合理设置多维表格的访问权限，确保数据安全

## 8. 联系方式

如果您在使用过程中遇到问题，可以联系相关技术人员获取帮助。
